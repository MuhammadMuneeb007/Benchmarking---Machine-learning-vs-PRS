
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Step 4 - MachineLearning &#8212; Benchmarking Polygenic Risk Scores vs. Machine Learning 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Step 5 - GetResults" href="Step%205%20-%20GetResults.html" />
    <link rel="prev" title="Step 3 - Pvaluethreshold" href="Step%203%20-%20Pvaluethreshold.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="step-4-machinelearning">
<h1>Step 4 - MachineLearning<a class="headerlink" href="#step-4-machinelearning" title="Permalink to this headline">¶</a></h1>
<div class="section" id="code-execution">
<h2>Code execution<a class="headerlink" href="#code-execution" title="Permalink to this headline">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">python MachineLearning.py (DirectoryName in which files will be stored)</span>
<span class="go">For example: python MachineLearning.py 1</span>
</pre></div>
</div>
</div>
<div class="section" id="actual-code-in-machinelearning">
<h2>Actual Code in MachineLearning<a class="headerlink" href="#actual-code-in-machinelearning" title="Permalink to this headline">¶</a></h2>
<p>Helper Functions and Imports.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">from __future__ import absolute_import, division, print_function</span>
<span class="go">import argparse</span>
<span class="go">from tensorflow.keras import Model, layers</span>
<span class="go">import numpy as np</span>

<span class="go">import pandas as pd</span>
<span class="go">from sklearn.preprocessing import StandardScaler</span>
<span class="go">from numpy import genfromtxt</span>
<span class="go">from sklearn import svm</span>

<span class="go">import matplotlib.pyplot as plt</span>
<span class="go">from sklearn.preprocessing import StandardScaler</span>

<span class="go">from sklearn.metrics import accuracy_score</span>
<span class="go">from sklearn.metrics import confusion_matrix</span>
<span class="go">import warnings</span>
<span class="go">warnings.filterwarnings(&#39;ignore&#39;)</span>

<span class="go">from datetime import datetime</span>
<span class="go">from sklearn.model_selection import RandomizedSearchCV, GridSearchCV</span>
<span class="go">from sklearn.metrics import roc_auc_score</span>
<span class="go">from sklearn.model_selection import StratifiedKFold</span>
<span class="go">scaler = StandardScaler()</span>
<span class="go">import tensorflow.keras</span>
<span class="go">from sklearn.metrics import precision_score, recall_score, accuracy_score</span>
<span class="go">from tensorflow.keras.models import Sequential, load_model</span>
<span class="go">from tensorflow.keras.layers import Dense, Dropout, Activation,ActivityRegularization</span>
<span class="go">from tensorflow.keras.utils import to_categorical</span>
<span class="go">from sklearn import metrics</span>
<span class="go">import tensorflow as tf</span>
<span class="go">from tensorflow.keras.layers import LSTM, GRU,Bidirectional</span>
<span class="go">from sklearn import preprocessing</span>
<span class="go">from tensorflow.keras.layers import Reshape</span>
<span class="go">import seaborn as sn</span>
<span class="go">import matplotlib.pyplot as plt</span>
<span class="go">from pylab import rcParams</span>
<span class="go">import sys</span>
<span class="go">import os</span>
<span class="go">from sklearn import tree, ensemble</span>
<span class="go">from imblearn.under_sampling import RandomUnderSampler</span>
<span class="go">from imblearn.pipeline import make_pipeline</span>
<span class="go">from sklearn.metrics import roc_auc_score</span>


<span class="go">def metric(name,best_model,x_train,y_train,x_test,y_test):</span>

<span class="go">   y_pred = best_model.predict(x_test)</span>
<span class="go">   sn.set(font_scale=2)</span>
<span class="go">   rcParams[&#39;figure.figsize&#39;] = 7, 7</span>
<span class="go">   confusion_matrix = pd.crosstab(y_test.argmax(axis=1), y_pred.argmax(axis=1), rownames=[&#39;Actual&#39;], colnames=[&#39;Predicted&#39;])</span>
<span class="go">   sn.heatmap(confusion_matrix, annot=True)</span>

<span class="go">   plt.savefig(args.path+os.sep+name+&quot;Test.png&quot;)</span>
<span class="go">   plt.clf()</span>
<span class="go">   confusion_matrix = pd.crosstab(y_train.argmax(axis=1), best_model.predict(x_train).argmax(axis=1), rownames=[&#39;Actual&#39;], colnames=[&#39;Predicted&#39;])</span>
<span class="go">   sn.heatmap(confusion_matrix, annot=True)</span>

<span class="go">   plt.savefig(args.path+os.sep+name+&quot;Train.png&quot;)</span>
<span class="go">   plt.clf()</span>


<span class="go">def plotting(history):</span>
<span class="go">   fig = plt.figure()</span>
<span class="go">   history_dict = history.history</span>
<span class="go">   print(history_dict.keys())</span>
<span class="go">   plt.subplot(2,1,1)</span>
<span class="go">   plt.plot(history_dict[&#39;accuracy&#39;])</span>
<span class="go">   plt.plot(history_dict[&#39;val_accuracy&#39;])</span>
<span class="go">   plt.title(&#39;model accuracy&#39;)</span>
<span class="go">   plt.ylabel(&#39;accuracy&#39;)</span>
<span class="go">   plt.xlabel(&#39;epoch&#39;)</span>
<span class="go">   plt.legend([&#39;Training Set&#39;, &#39;Validation Set&#39;], loc=&#39;lower right&#39;)</span>

<span class="go">   plt.subplot(2,1,2)</span>


<span class="go">   plt.plot( history_dict[&#39;loss&#39;])</span>
<span class="go">   plt.plot( history_dict[&#39;val_loss&#39;])</span>
<span class="go">   plt.title(&#39;model loss&#39;)</span>
<span class="go">   plt.ylabel(&#39;loss&#39;)</span>
<span class="go">   plt.xlabel(&#39;epoch&#39;)</span>
<span class="go">   plt.legend([&#39;Training Set&#39;, &#39;Validation Set&#39;], loc=&#39;upper right&#39;)</span>

<span class="go">   plt.tight_layout()</span>
</pre></div>
</div>
<p>Machine learning models. This code is designed so that it can be used for hyper-parameter optimization.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">import pandas as pd</span>
<span class="go">from os import makedirs</span>


<span class="go">def model1(name,activationfunction=[&quot;sigmoid&quot;],dropout=[5],optimizer = [&quot;Adam&quot;],batch_size =[5],epochs=[30],l1=[0.01],l2=[0],validationsplit=[0.3]):</span>
<span class="go">   for activation in activationfunction:</span>
<span class="go">      for drop in dropout:</span>
<span class="go">         for opt in optimizer:</span>
<span class="go">            for b in batch_size:</span>
<span class="go">               for e in epochs:</span>
<span class="go">                  for v in validationsplit:</span>
<span class="go">                     model = Sequential()</span>
<span class="go">                     model.add(Dense(100, input_shape=(x_train.shape[1],)))</span>
<span class="go">                     model.add(Activation(activation))</span>
<span class="go">                     model.add(Dropout(drop))</span>
<span class="go">                     model.add(Dense(50))</span>
<span class="go">                     model.add(Activation(activation))</span>
<span class="go">                     model.add(Dropout(drop))</span>
<span class="go">                     model.add(Dense(1))</span>
<span class="go">                     model.add(Activation(&quot;sigmoid&quot;))</span>
<span class="go">                     model.compile(loss=&#39;binary_crossentropy&#39;, metrics=[&#39;accuracy&#39;], optimizer=opt)</span>
<span class="go">                     history = model.fit(X_train, Y_train,batch_size=b, epochs=e,validation_split=v,verbose=0)</span>
<span class="go">                     loss, acc = model.evaluate(X_test, Y_test)</span>
<span class="go">                     Y_pred = model.predict(X_test)</span>

<span class="go">                     print(str(activation),str(drop),str(opt),str(b),str(e),str(v))</span>
<span class="go">                     print(&quot;train AUC&quot;,roc_auc_score(Y_train, model.predict(X_train)))</span>
<span class="go">                     print(&quot;test AUC&quot;,roc_auc_score(Y_test, model.predict(X_test)))</span>

<span class="gp">                     #</span> Return class prediction probabilities.
<span class="go">                     return np.amax(Y_pred,axis=1)</span>
</pre></div>
</div>
<p>Training model for all p-value thresholds.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">direc = sys.argv[1]</span>
<span class="go">trainpath= &quot;./&quot;+direc+os.sep+&quot;train/&quot;</span>
<span class="go">testpath = &quot;./&quot;+direc+os.sep+&quot;test/&quot;</span>
<span class="go">allsnps = os.listdir(&quot;./&quot;+direc)</span>

<span class="go">from xgboost import XGBClassifier</span>
<span class="go">for files in allsnps:</span>
<span class="gp">   #</span>print<span class="o">(</span>files<span class="o">)</span>
<span class="go">   if &quot;_snps&quot; not in files and &quot;pv_&quot; in files:</span>
<span class="go">      x_train = pd.read_csv(&quot;./&quot;+direc+os.sep+files+os.sep+&#39;ptrain.raw&#39;, sep=&quot;\s+&quot;)</span>
<span class="go">      x_test = pd.read_csv(&quot;./&quot;+direc+os.sep+files+os.sep+&#39;ptest.raw&#39;, sep=&quot;\s+&quot;)</span>
<span class="go">      y_train  = pd.read_csv(trainpath+&#39;YRI.pheno&#39;, sep=&quot;\s+&quot;)</span>
<span class="go">      y_test= pd.read_csv(testpath+&#39;YRI.pheno&#39;, sep=&quot;\s+&quot;)</span>
<span class="go">      x_train =x_train.iloc[:,6:].values</span>
<span class="go">      x_test  =x_test.iloc[:,6:].values</span>
<span class="go">      y_train =y_train.iloc[:,2:].values</span>
<span class="go">      y_test =y_test.iloc[:,2:].values</span>


<span class="go">      scaler = StandardScaler()</span>
<span class="go">      std_scale = preprocessing.StandardScaler().fit(x_train)</span>
<span class="go">      x_train = std_scale.transform(x_train)</span>
<span class="go">      x_test = std_scale.transform(x_test)</span>



<span class="go">      X_train = x_train</span>
<span class="go">      X_test = x_test</span>
<span class="go">      Y_train = y_train</span>
<span class="go">      Y_test = y_test</span>







<span class="go">      activationFunctions = [&quot;relu&quot;]</span>
<span class="go">      ddropout = [0.2]</span>
<span class="go">      optimizer = [&quot;Adam&quot;]</span>
<span class="go">      batchsize = [50]</span>
<span class="go">      epochsnumber = [100]</span>
<span class="go">      validation = [0.3]</span>
<span class="go">      data = model1(&quot;ANN1&quot;,activationFunctions,ddropout,optimizer,batchsize,epochsnumber,l1=[0],l2=[0],validationsplit=validation)</span>
<span class="go">      x = pd.DataFrame()</span>
<span class="go">      x[&#39;0&#39;] = data</span>
<span class="go">      x.to_csv(direc+os.sep+files+os.sep+&quot;ML_probability&quot;,header=False, index=False)</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Benchmarking Polygenic Risk Scores vs. Machine Learning</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Step%200%20-%20Generate%20Data.html">Step 0 - Generate Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Step%201%20-%20Divide%20Data%20into%20Base%20and%20Target%20sets.html">Step 1 - Divide Data into Base and Target sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="Step%202%20-%20CalculatePRS.html">Step 2 - CalculatePRS</a></li>
<li class="toctree-l1"><a class="reference internal" href="Step%202.0%20-%20QCTarget.R.html">Step 2.0 - QCTarget.R</a></li>
<li class="toctree-l1"><a class="reference internal" href="Step%203%20-%20Pvaluethreshold.html">Step 3 - Pvaluethreshold</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Step 4 - MachineLearning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#code-execution">Code execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#actual-code-in-machinelearning">Actual Code in MachineLearning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Step%205%20-%20GetResults.html">Step 5 - GetResults</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Step%203%20-%20Pvaluethreshold.html" title="previous chapter">Step 3 - Pvaluethreshold</a></li>
      <li>Next: <a href="Step%205%20-%20GetResults.html" title="next chapter">Step 5 - GetResults</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Muhammad Muneeb and Samuel F. Feng.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/Step 4 - MachineLearning.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>